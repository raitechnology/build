
Rai Protocol for Cache Backed Pub Sub
=====================================
:toc: left

About
~~~~~

This document describes a caching layer on top of existing pubsub systems.
Pubsub provides for a multiplexed subject adressed based stream of messages
from publisher to subscriber.  Pubsub is usually layered on top of a reliable
based transport, such as TCP or PGM.  The multicast supported by the
architectures is either point to point TCP fanout of subscription interest or
built on top of a reliable multicast UDP transport.  The publisher can be a
feed service, performing last value caching and trasforming the events into
subject streams, or it may be a cache based router, which distrubutes publisher
services across multiple nodes in order to scale networks.

The caching layer includes methods for synchronizing state distributed across a
network of nodes.  The most important of this extended functionality is
subscription management, which includes methods beyond pubsub that allow for
network endpoints, the publisher and the subscriber, to encode cache semantics,
fault tolerance, and subscription visibility.

Cache backed subscription operations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

. Subscription Listen

- A message from a client that multicasts to a well known endpoint with
  notification of a subscripion start.  This message contains infromation
  identifying the client uniquely.

. Subscription Intial

- This extends the subscription listen to also provide a client endpoint for
  intializing the image associated with the subscription.

. Update Publish

- After one or more subscription interestes are known, the publisher provides
  updates to the subscription.

. Unsubscribe

- This message multicasts to the well known endpoint with a notification of a
  subscription stop using the unique identification sent with the subscription
  start.

. Refresh Initial

- In the event that a subject stream is disrupted by network or node failure,
  this reestablishes the initial state of the subject, which has become stale.

. Reassert Subscription

- This message resets any timers associated with subscription by the publisher.
  A publisher may drop subscriptions that have not been active after a period
  of time.

. Drop Notification

- In the event that a subscription timer expires, this notifies any client that
  may be active that the publisher dropped the subscription and is no longer
  forwarding messages.  If a client is still active, it must reasert or restart
  the subscription.

. Stale Notification

- If the publisher is no longer able to provide updates or has lost sequences
  of messages associated with a subject, this notifies the client that the
  current state is stale.  This may cause clients to restart a subscription on
  another path or they may need to wait for the publisher to restore the
  subject stream.

. Not Found Notification

- When a subscription listen starts, this reply notifies the client that the
  subscription is established, but that no published data is currently
  available.

. Verify Notification

- Another form of subscription listen start reply where the publisher notifies
  that no published data is available, but is expected to be ready soon.  This
  often includes a zeroed record associated with the subject so that the client
  can initialize its internal state and be ready for updates.

. Feed Down

- A form of stale notification that may include information about the publisher
  state.

. Feed Switch

- A form of stale notification that indicates a gap or duplication of the
  stream may occur as the source path of the stream has changed, such as a
  primary to secondary flip.

. Subscription Expired

- If a subject stream is permanently ended, this notifies that the publisher no
  longer intends send updates.

. Recap Publish

- When a feed switch, or primary to secondary flip, occurs, a recap of the
  latest updates are published in order to insure that the stream is up to
  date.  These messages can be combined so that all of the data up to the last
  published update are recapped for the configured time period.

. Conflated Publish

- If a subject stream has reduced bandwidth, a conflated message encodes
  multiple updates into a single update.  This allows a publisher to increase
  the reliability with a reduction in message rate when the latency of updates
  is not as important.

. Dictionary

- If a dictionary is associated with the messages sent, this well known
  endpoint can be used by clients to download the latest dictionary.  If a
  dictionary is not static, subscription for dictionary updates is also
  started.

. Entitlements

- When a system is designed for licensed access to data, it is necessary to
  track the activity of the clients.  This service endpoint encodes the access
  levels and the logging of subscription events.

Protocols supported
~~~~~~~~~~~~~~~~~~~

The following protocols will be described for each of the operations needed
for a cache aware pubsub system.

- RV
- NATS
- Redis
- CAPR
- Http/Websocket
- OpenPGM

RV
~~

SASS2 base, most of the architecture already supports many of the features
needed.

Todo.. describe SASS2.

NATS
~~~~

NATS does not natively have subscription management, so much of the caching
semantics has to be layered on top of the base pubsub system.

Todo.. describe NATS + subscription management.

Redis
~~~~~

Redis also does not nately have subscripton management, but it does have a
complex array of caching semantics that may be used.

Todo.. describe Redis + subscription management.

Http/Websocket
~~~~~~~~~~~~~~

This is basically the same as the Redis case, since the caching semantics
works as the Redis RESP protocol is layered over the Websocket protocol.

OpenPGM
~~~~~~~

This is a transport, not a pubsub sytem.  The history of PGM flows through
early caching systems by Tibco, to RFC, to open source.

Todo.. describe OpenPGM + pubsub + subscription management.


